$gwx_XC_152=function(_,_v,_n,_p,_s,_wp,_wl,$gwn,$gwl,$gwh,wh,$gstack,$gwrt,gra,grb,TestTest,wfor,_ca,_da,_r,_rz,_o,_oz,_1,_1z,_2,_2z,_m,_mz,nv_getDate,nv_getRegExp,nv_console,nv_parseInt,nv_parseFloat,nv_isNaN,nv_isFinite,nv_decodeURI,nv_decodeURIComponent,nv_encodeURI,nv_encodeURIComponent,$gdc,nv_JSON,_af,_gv,_ai,_grp,_gd,_gapi,$ixc,_ic,_w,_ev,_tsd){return function(path,global){
if(typeof global==='undefined'){if (typeof __GWX_GLOBAL__==='undefined')global={};else global=__GWX_GLOBAL__;}if(typeof __WXML_GLOBAL__ === 'undefined') {__WXML_GLOBAL__={};
}__WXML_GLOBAL__.modules = __WXML_GLOBAL__.modules || {};
var e_={}
if(typeof(global.entrys)==='undefined')global.entrys={};e_=global.entrys;
var d_={}
if(typeof(global.defines)==='undefined')global.defines={};d_=global.defines;
var f_={}
if(typeof(global.modules)==='undefined')global.modules={};f_=global.modules || {};
var p_={}
__WXML_GLOBAL__.ops_cached = __WXML_GLOBAL__.ops_cached || {}
__WXML_GLOBAL__.ops_set = __WXML_GLOBAL__.ops_set || {};
__WXML_GLOBAL__.ops_init = __WXML_GLOBAL__.ops_init || {};
var z=__WXML_GLOBAL__.ops_set.$gwx_XC_152 || [];
function gz$gwx_XC_152_1(){
if( __WXML_GLOBAL__.ops_cached.$gwx_XC_152_1)return __WXML_GLOBAL__.ops_cached.$gwx_XC_152_1
__WXML_GLOBAL__.ops_cached.$gwx_XC_152_1=[];
(function(z){var a=11;function Z(ops){z.push(ops)}
Z([3,'inquery-main-container'])
Z([[2,'||'],[[2,'||'],[[2,'==='],[[7],[3,'pageType']],[1,1]],[[2,'==='],[[7],[3,'pageType']],[1,4]]],[[2,'==='],[[7],[3,'pageType']],[1,2]]])
Z([[7],[3,'headerTabIndex']])
Z([[2,'?:'],[[6],[[7],[3,'urlData']],[3,'problem_id']],[1,'specific'],[1,'normal']])
Z([3,'main-section-scroll-view'])
Z([3,'scroll-view'])
Z([[7],[3,'scrollAnchor']])
Z([1,true])
Z(z[7])
Z([[2,'&&'],[[6],[[7],[3,'messageStream']],[3,'tip_origin']],[[2,'!'],[[7],[3,'shouldDefaultMessageHide']]]])
Z([[6],[[7],[3,'messageStream']],[3,'tip']])
Z([[6],[[7],[3,'urlData']],[3,'problem_id']])
Z([[7],[3,'certificateDoctorInfo']])
Z(z[9])
Z([[2,'&&'],[[6],[[7],[3,'messageStream']],[3,'guide']],[[7],[3,'fakeReady']]])
Z([[6],[[7],[3,'messageStream']],[3,'doctor_avatar']])
Z([[6],[[7],[3,'messageStream']],[3,'doctor_name']])
Z([[6],[[7],[3,'messageStream']],[3,'guide']])
Z([3,'doctor'])
Z([[2,'&&'],[[2,'&&'],[[2,'&&'],[[7],[3,'shouldHistorySelectorShow']],[[7],[3,'fakeReady']]],[[6],[[7],[3,'messageStream']],[3,'quick_input']]],[[6],[[6],[[7],[3,'messageStream']],[3,'quick_input']],[3,'length']]])
Z([3,'onSelectHistory'])
Z([[6],[[7],[3,'messageStream']],[3,'draft_tip']])
Z([[7],[3,'fromTypeForTrack']])
Z([[6],[[7],[3,'messageStream']],[3,'quick_input']])
Z([[7],[3,'shouldDefaultMessageHide']])
Z(z[15])
Z([[7],[3,'blackListMessage']])
Z(z[18])
Z([[7],[3,'messagePool']])
Z([3,'text'])
Z([[6],[[7],[3,'item']],[3,'avatar']])
Z([3,'previewImage'])
Z([[6],[[7],[3,'item']],[3,'contentType']])
Z(z[32])
Z([[6],[[7],[3,'item']],[3,'imgPath']])
Z(z[16])
Z(z[34])
Z([[6],[[7],[3,'item']],[3,'text']])
Z([[6],[[7],[3,'item']],[3,'type']])
Z([[2,'&&'],[[2,'==='],[[7],[3,'operatingSectionIndex']],[1,4]],[[7],[3,'shouldServiceListShow']]])
Z([3,'handleSelectBasicService'])
Z([3,'toggleComponent'])
Z(z[22])
Z([[7],[3,'recommendInfo']])
Z([[7],[3,'serviceList']])
Z([[2,'||'],[[2,'&&'],[[2,'==='],[[7],[3,'operatingSectionIndex']],[1,4]],[[6],[[6],[[7],[3,'recommendInfo']],[3,'recommend_doctor']],[3,'length']]],[[2,'&&'],[[2,'==='],[[7],[3,'pageType']],[1,4]],[[2,'==='],[[7],[3,'operatingSectionIndex']],[1,4]]]])
Z([3,'handleFindDoctorFastPay'])
Z([3,'handleGoToFindDoc'])
Z([3,'handleSelectDoctors'])
Z([[2,'==='],[[7],[3,'pageType']],[1,4]])
Z(z[43])
Z([[2,'&&'],[[7],[3,'shouldBottomButtonSectionShow']],[[2,'!'],[[7],[3,'isInBlackList']]]])
Z([a,[3,'operating-section inquery-main-flex-item '],[[2,'?:'],[[2,'&&'],[[7],[3,'hasInputFocused']],[[2,'==='],[[7],[3,'operatingSectionIndex']],[1,0]]],[1,'no-padding'],[1,'']]])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,0]])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,1]])
Z([3,'handleSingleImageUpload'])
Z([3,'refusePhoneNumber'])
Z([3,'handleSkipToArchive'])
Z([3,'handleToArchive'])
Z([3,'handleUpdateImageList'])
Z([3,'handleUnauthorize'])
Z(z[22])
Z([[7],[3,'hasBindPhoneNumber']])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,2]])
Z([3,'handleArchiveRenderReady'])
Z([3,'handleSelectArchive'])
Z(z[22])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,3]])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,4]])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,5]])
Z([3,'relogin'])
Z([[2,'==='],[[7],[3,'operatingSectionIndex']],[1,6]])
Z([3,'getPhoneNUmber'])
Z([3,'floating-section'])
Z([3,'handleConfirmClinic'])
Z(z[41])
Z([[6],[[7],[3,'recommendInfo']],[3,'triage_first_clinic_no']])
Z([[6],[[7],[3,'recommendInfo']],[3,'triage_second_clinic_no']])
Z([[7],[3,'shouldClinicSelectorShow']])
Z([3,'handleConfirmPhone'])
Z([3,'handleHidePhoneInput'])
Z([[7],[3,'userPhone']])
Z([[7],[3,'shouldPhoneInputShow']])
Z([[7],[3,'shouldCouponDialogShow']])
Z([3,'onGetCoupon'])
Z([[7],[3,'couponId']])
})(__WXML_GLOBAL__.ops_cached.$gwx_XC_152_1);return __WXML_GLOBAL__.ops_cached.$gwx_XC_152_1
}
__WXML_GLOBAL__.ops_set.$gwx_XC_152=z;
__WXML_GLOBAL__.ops_init.$gwx_XC_152=true;
var x=['./pages/inquery/inquery.wxml'];d_[x[0]]={}
var m0=function(e,s,r,gg){
var z=gz$gwx_XC_152_1()
var lACB=_n('view')
_rz(z,lACB,'class',0,e,s,gg)
var aBCB=_v()
_(lACB,aBCB)
if(_oz(z,1,e,s,gg)){aBCB.wxVkey=1
var eDCB=_mz(z,'header',['currentIndex',2,'headerType',1],[],e,s,gg)
_(aBCB,eDCB)
}
var bECB=_mz(z,'scroll-view',['class',4,'id',1,'scrollIntoView',2,'scrollWithAnimation',3,'scrollY',4],[],e,s,gg)
var oNCB=_n('service-card')
_(bECB,oNCB)
var oFCB=_v()
_(bECB,oFCB)
if(_oz(z,9,e,s,gg)){oFCB.wxVkey=1
var lOCB=_n('system-info')
_rz(z,lOCB,'tip',10,e,s,gg)
_(oFCB,lOCB)
}
var xGCB=_v()
_(bECB,xGCB)
if(_oz(z,11,e,s,gg)){xGCB.wxVkey=1
var aPCB=_n('doctor-card')
_rz(z,aPCB,'doctorInfo',12,e,s,gg)
_(xGCB,aPCB)
}
var oHCB=_v()
_(bECB,oHCB)
if(_oz(z,13,e,s,gg)){oHCB.wxVkey=1
}
var fICB=_v()
_(bECB,fICB)
if(_oz(z,14,e,s,gg)){fICB.wxVkey=1
var tQCB=_mz(z,'single-message',['avatar',15,'doctorName',1,'text',2,'type',3],[],e,s,gg)
_(fICB,tQCB)
}
var cJCB=_v()
_(bECB,cJCB)
if(_oz(z,19,e,s,gg)){cJCB.wxVkey=1
var eRCB=_mz(z,'history-selector',['bind:select-history',20,'draftTip',1,'fromTypeForTrack',2,'quickInput',3],[],e,s,gg)
_(cJCB,eRCB)
}
var hKCB=_v()
_(bECB,hKCB)
if(_oz(z,24,e,s,gg)){hKCB.wxVkey=1
var bSCB=_mz(z,'single-message',['avatar',25,'text',1,'type',2],[],e,s,gg)
_(hKCB,bSCB)
}
var oTCB=_v()
_(bECB,oTCB)
var xUCB=function(fWCB,oVCB,cXCB,gg){
var oZCB=_mz(z,'single-message',['avatar',30,'bind:tap',1,'contentType',2,'data-contenttype',3,'data-url',4,'doctorName',5,'imgPath',6,'text',7,'type',8],[],fWCB,oVCB,gg)
_(cXCB,oZCB)
return cXCB
}
oTCB.wxXCkey=4
_2z(z,28,xUCB,e,s,gg,oTCB,'item','index','text')
var oLCB=_v()
_(bECB,oLCB)
if(_oz(z,39,e,s,gg)){oLCB.wxVkey=1
var c1CB=_mz(z,'basic-recommend-doctor',['bind:select-service',40,'bind:show-clinic-selector',1,'fromTypeForTrack',2,'recommendInfo',3,'serviceList',4],[],e,s,gg)
_(oLCB,c1CB)
}
var cMCB=_v()
_(bECB,cMCB)
if(_oz(z,45,e,s,gg)){cMCB.wxVkey=1
var o2CB=_mz(z,'more-recommend-doctor',['bind:find-doc-fast-pay',46,'bind:go-to-find-doc',1,'bind:select-doctors',2,'isFindDocFast',3,'recommendInfo',4],[],e,s,gg)
_(cMCB,o2CB)
}
oFCB.wxXCkey=1
oFCB.wxXCkey=3
xGCB.wxXCkey=1
xGCB.wxXCkey=3
oHCB.wxXCkey=1
fICB.wxXCkey=1
fICB.wxXCkey=3
cJCB.wxXCkey=1
cJCB.wxXCkey=3
hKCB.wxXCkey=1
hKCB.wxXCkey=3
oLCB.wxXCkey=1
oLCB.wxXCkey=3
cMCB.wxXCkey=1
cMCB.wxXCkey=3
_(lACB,bECB)
var tCCB=_v()
_(lACB,tCCB)
if(_oz(z,51,e,s,gg)){tCCB.wxVkey=1
var l3CB=_n('view')
_rz(z,l3CB,'class',52,e,s,gg)
var a4CB=_v()
_(l3CB,a4CB)
if(_oz(z,53,e,s,gg)){a4CB.wxVkey=1
}
var t5CB=_v()
_(l3CB,t5CB)
if(_oz(z,54,e,s,gg)){t5CB.wxVkey=1
var fADB=_mz(z,'image-selection',['bind:complete-single-upload',55,'bind:refuse-phone-number',1,'bind:skip-to-archive',2,'bind:to-archive',3,'bind:update-image-list',4,'bind:usernoauthorize',5,'fromTypeForTrack',6,'hasBindPhoneNumber',7],[],e,s,gg)
_(t5CB,fADB)
}
var e6CB=_v()
_(l3CB,e6CB)
if(_oz(z,63,e,s,gg)){e6CB.wxVkey=1
var cBDB=_mz(z,'archive-selection',['bind:archive-render-ready',64,'bind:select-archive',1,'fromTypeForTrack',2],[],e,s,gg)
_(e6CB,cBDB)
}
var b7CB=_v()
_(l3CB,b7CB)
if(_oz(z,67,e,s,gg)){b7CB.wxVkey=1
}
var o8CB=_v()
_(l3CB,o8CB)
if(_oz(z,68,e,s,gg)){o8CB.wxVkey=1
}
var x9CB=_v()
_(l3CB,x9CB)
if(_oz(z,69,e,s,gg)){x9CB.wxVkey=1
var hCDB=_n('cy-userinfo')
_rz(z,hCDB,'bind:loginevent',70,e,s,gg)
_(x9CB,hCDB)
}
var o0CB=_v()
_(l3CB,o0CB)
if(_oz(z,71,e,s,gg)){o0CB.wxVkey=1
var oDDB=_n('bind-phone')
_rz(z,oDDB,'bind:get-phone',72,e,s,gg)
_(o0CB,oDDB)
}
a4CB.wxXCkey=1
t5CB.wxXCkey=1
t5CB.wxXCkey=3
e6CB.wxXCkey=1
e6CB.wxXCkey=3
b7CB.wxXCkey=1
o8CB.wxXCkey=1
x9CB.wxXCkey=1
x9CB.wxXCkey=3
o0CB.wxXCkey=1
o0CB.wxXCkey=3
_(tCCB,l3CB)
}
var cEDB=_n('view')
_rz(z,cEDB,'class',73,e,s,gg)
var lGDB=_mz(z,'clinic-selector',['bind:confirm-clinic',74,'bind:toggle-component',1,'defaultFirst',2,'defaultSecond',3,'shouldClinicSelectorShow',4],[],e,s,gg)
_(cEDB,lGDB)
var aHDB=_mz(z,'phone-input',['bind:confirm-phone',79,'bind:hide-phone-input',1,'phone',2,'shouldShow',3],[],e,s,gg)
_(cEDB,aHDB)
var oFDB=_v()
_(cEDB,oFDB)
if(_oz(z,83,e,s,gg)){oFDB.wxVkey=1
var tIDB=_mz(z,'coupon-dialog',['bind:get-coupon',84,'couponId',1],[],e,s,gg)
_(oFDB,tIDB)
}
oFDB.wxXCkey=1
oFDB.wxXCkey=3
_(lACB,cEDB)
aBCB.wxXCkey=1
aBCB.wxXCkey=3
tCCB.wxXCkey=1
tCCB.wxXCkey=3
_(r,lACB)
return r
}
e_[x[0]]={f:m0,j:[],i:[],ti:[],ic:[]}
if(path&&e_[path]){
return function(env,dd,global){$gwxc=0;var root={"tag":"wx-page"};root.children=[]
;g="$gwx_XC_152";var main=e_[path].f
if (typeof global==="undefined")global={};global.f=$gdc(f_[path],"",1);
try{
main(env,{},root,global);
_tsd(root)
}catch(err){
console.log(err)
}
;g="";
return root;
}
}
}
}(__g.a,__g.b,__g.c,__g.d,__g.e,__g.f,__g.g,__g.h,__g.i,__g.j,__g.k,__g.l,__g.m,__g.n,__g.o,__g.p,__g.q,__g.r,__g.s,__g.t,__g.u,__g.v,__g.w,__g.x,__g.y,__g.z,__g.A,__g.B,__g.C,__g.D,__g.E,__g.F,__g.G,__g.H,__g.I,__g.J,__g.K,__g.L,__g.M,__g.N,__g.O,__g.P,__g.Q,__g.R,__g.S,__g.T,__g.U,__g.V,__g.W,__g.X,__g.Y,__g.Z,__g.aa);if(__vd_version_info__.delayedGwx||false)$gwx_XC_152();	if (__vd_version_info__.delayedGwx) __wxAppCode__['pages/inquery/inquery.wxml'] = [$gwx_XC_152, './pages/inquery/inquery.wxml'];else __wxAppCode__['pages/inquery/inquery.wxml'] = $gwx_XC_152( './pages/inquery/inquery.wxml' );
	;__wxRoute = "pages/inquery/inquery";__wxRouteBegin = true;__wxAppCurrentFile__="pages/inquery/inquery.js";define("pages/inquery/inquery.js",function(require,module,exports,window,document,frames,self,location,navigator,localStorage,history,Caches,screen,alert,confirm,prompt,XMLHttpRequest,WebSocket,Reporter,webkit,WeixinJSCore){
"use strict";var e=require("../../@babel/runtime/helpers/interopRequireDefault"),t=require("../../@babel/runtime/helpers/defineProperty"),a=require("../../@babel/runtime/helpers/objectSpread2"),o=require("../../BC983DD1829A079CDAFE55D6E84D7B70.js"),i=require("../../92BC1755829A079CF4DA7F52C55D7B70.js"),n=require("../../43A2F676829A079C25C49E711B4C7B70.js"),s=e(require("../../7B9C8496829A079C1DFAEC91795C7B70.js")),c=getApp(),r="".concat(o.baseUrl,"/qa_operation/quick_ask/create_qa_init/"),d="".concat(o.baseUrl,"/qa_operation/quick_ask/save_draft/"),l="".concat(o.baseUrl,"/qa_operation/quick_ask/check_problem_content/"),h="".concat(o.baseUrl,"/qa_operation/quick_ask/recommend_doctor/?from_wx_mini=1"),u=o.baseUrl+"/qa_operation/quick_ask/get_valid_to_clinic_service/?from_wx_mini=1",m=o.baseUrl+"/cooperation/wap/create_problem_content/",p="".concat(o.baseUrl,"/user_operation/check_user_in_blacklist/"),_=["gsjW4tDz6sTzuwUMhvWfPeRlkj0W5aZ7U5eVW6BRqyA"],f="".concat(o.baseUrl,"/api/v7/new_user/coupon/"),g="".concat(o.baseUrl,"/cy_wx/public/can_skip_phone/"),D="".concat(o.baseUrl,"/cooperation/wap/is_user_login/");Page({data:{urlData:{from_page:"",problem_id:"",emergency_clinic_no:"",initial_content:"",doctor_name:""},isInBlackList:!1,shouldDefaultMessageHide:!1,blackListMessage:"因违背提问规则，此功能暂不可用。如有疑问请联系春雨在线客服",headerTabIndex:0,isPhoneNumberRequested:!0,operatingSectionIndex:0,messageStream:{},messagePool:[],hasImageSelectionSubmitted:!1,imgListForMessageStream:[],shouldClinicSelectorShow:!1,selectedClinic:{},recommendInfo:{recommend_doctor:[]},selectedArchive:{},serviceList:{},selectedBasicService:{},selectedRecommendDoctors:[],selectedClinicObj:{},priceForButtonShow:0,scrollAnchor:"",userPhone:"",pageType:1,shouldServiceListShow:!0,shouldBottomButtonSectionShow:!0,shouldFindDocFastButtonShow:!1,formData:{inputValue:"",imgUrlList:[],archive:{},contentStr:""},shouldListenImgUpdate:!1,isUserRefuseToAuthorize:!1,shouldPhoneInputShow:!1,isFirstLoad:!0,hasVideoVarified:!1,scorllPlaceholderHeight:0,fromTypeForTrack:"",textAreaBottom:0,hasInputFocused:!0,keyboardHeight:0,selectedRecommendDoctorIndexs:[],selectedBasicServiceIndex:999,shouldCouponDialogShow:!1,shouldShowAlertBeforeLeave:!1,couponId:"",hasReselectClinic:!1,shouldHistorySelectorShow:!0,certificateDoctorInfo:{},fakeReady:!0,showCount:10,hasBindPhoneNumber:!0},TRACK_MAP:{fast_qa:"快速问诊",find_doc_fast:"一键找医生",all_service:"我的咨询",emergency:"图文急诊",tel_inquiry_detail:"电话详情",home_search:"大搜",article:"科普详情页",doctor_topic:"医生话题页",baichuan:"ai问诊"},SCROLL_DEBOUNCE:null,onLoad:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,n.isLogin)().then((function(){console.log("login"),e.getUserDetail(),e.checkCanSkipPhone()})).catch((function(){(0,n.autoLogin)().then((function(){e.getUserDetail(),e.checkCanSkipPhone()}))})),this.SCROLL_DEBOUNCE=(0,i.debounce)(this.scrollToBottom,100),this.data.isFirstLoad=!1;var o=t.from_page,s=t.problem_id,r=t.emergency_clinic_no,d=t.initial_content,l=t.doctor_name,h=t.service_id;console.log("携带过来的problem_id",s),this.setData({"urlData.from_page":o||"","urlData.problem_id":s||"","urlData.emergency_clinic_no":r||"","urlData.initial_content":d||"","urlData.doctor_name":l||"","urlData.service_id":h||""}),"tel_inquiry_detail"!==this.data.urlData.from_page&&"tel_inquiry"!==this.data.urlData.from_page||this.setData({showCount:1}),this.data.urlData.problem_id?(this.setData({pageType:2}),wx.enableAlertBeforeUnload({message:"医生将在您发送病情描述后接诊，确认离开？"})):"emergency"===this.data.urlData.from_page?this.setData({pageType:3}):"find_doc_fast"===this.data.urlData.from_page&&this.setData({pageType:4}),this.getDraft(),this.setData({fromTypeForTrack:this.TRACK_MAP[this.data.urlData.from_page]||"未知"}),"fast_qa"===this.data.urlData.from_page&&this.checkBlackList().catch((function(){e.setData({shouldDefaultMessageHide:!0,isInBlackList:!0})})),this.data.keyboardHeight=c.globalData.keyboardHeight,c.sensors.track("PageView",a({app:"weixin_mini",page_readable_name:"病情描述",from_type:this.data.fromTypeForTrack},this.data.urlData.service_id&&{service_id:this.data.urlData.service_id}))},onShow:function(){var e=Number(wx.getStorageSync("fast-phone-fail")),t=Number(wx.getStorageSync("video-varified"));1===e&&(this.getRecommendDoctorInfo(this.data.selectedClinicObj.clinic_no),wx.removeStorageSync("fast-phone-fail")),1===t&&(wx.removeStorageSync("video-varified"),this.generatePayParams())},onHide:function(){this.saveDraft()},handleToArchive:function(e){var t=this;this.track("AppClick",{click_position:"确定发送病情资料",page_readable_name:"病情描述"}),this.saveDraft(),this.checkBlackList().then((function(){wx.nextTick((function(){t.changeSectionIndex(2),t.changeTabIndex(2),t.pushToMessagePool("doctor",t.data.messageStream.select_ehr,"text")}))})).catch((function(){t.pushToMessagePool("doctor",t.data.blackListMessage,"text"),t.setData({isInBlackList:!0})}))},changeSectionIndex:function(e){this.setData({operatingSectionIndex:e})},getDraft:function(){var e=this;(0,s.default)({url:r,data:a({problem_id:this.data.urlData.problem_id,chunyu_wap:"chunyu_wap"},"fast_qa"===this.data.urlData.from_page&&{from_type:"quick_ask"}),method:"GET",success:function(t){t.data&&0===t.data.error_code?(e.data.urlData.initial_content&&(t.data.data.draft=""),e.setData({messageStream:t.data.data,"formData.inputValue":e.data.urlData.initial_content,certificateDoctorInfo:t.data.data.doctor_info})):wx.showToast({icon:"none",title:"初始化页面失败"})},fail:function(){wx.showToast({icon:"none",title:"初始化页面失败"})}})},startNew:function(){this.track("AppClick",{click_position:"草稿页-咨询新问题",page_readable_name:"病情描述"}),this.setData({"formData.inputValue":""}),this.changeSectionIndex(0)},continue:function(){var e=this;this.track("AppClick",{click_position:"草稿页-继续咨询",page_readable_name:"病情描述"}),this.changeSectionIndex(0),wx.nextTick((function(){e.setData({"formData.inputValue":e.data.messageStream.draft||""})}))},checkBlackList:function(){var e=this;return new Promise((function(t,a){if(2===e.data.pageType)return t();wx.request({url:p,header:{Cookie:c.globalData.sessionid},success:function(o){return 1===o.data.error_code?a(o.data.error_msg):(e.data.isInBlackList=!1,t())},fail:function(){return e.data.isInBlackList=!1,t("网络请求异常")}})}))},textAreaInput:function(e){this.data.formData.inputValue=e.detail.value},saveDraft:function(){var e=this;return new Promise((function(t,a){wx.request({url:d,header:{Cookie:c.globalData.sessionid},data:{ask_text:e.data.formData.inputValue},method:"GET",complete:function(){return t()}})}))},checkProblemContent:function(){var e={ask_text:this.data.formData.inputValue};return["tel_inquiry","tel_inquiry_detail"].indexOf(this.data.urlData.from_page)>=0&&(e.service_type="inquiry"),new Promise((function(t,a){(0,s.default)({url:l,data:e,method:"GET",success:function(e){return 0===e.data.error_code?e.data.error_msg.length?a(e.data):t():a(e.data)},fail:function(){return a({error_type:"failed_request",error_msg:"网络异常，请稍后重试"})}})}))},pushToMessagePool:function(e,t,a){var o=this.data.messagePool,i={type:e,contentType:a,avatar:this.data.messageStream.doctor_avatar};"image"===a?i.imgPath=t:i.text=t,o.push(i),this.setData({messagePool:o})},sendInputValue:function(){var e,t=this;(null===(e=this.data.formData.inputValue)||void 0===e?void 0:e.trim().length)>=this.data.showCount?(this.track("AppClick",{click_position:"发送病情描述",page_readable_name:"病情描述"}),this._loading(),this.checkProblemContent().then((function(){wx.hideLoading(),t.subscribeMessage(_),t.saveDraft(),t.pushToMessagePool("patient",t.data.formData.inputValue,"text"),t.pushToMessagePool("doctor",t.data.messageStream.upload_img,"text"),t.setData({shouldHistorySelectorShow:!1}),t.changeSectionIndex(1),t.changeTabIndex(1),setTimeout(t.scrollToBottom,200)})).catch((function(e){"failed_request"===e.error_type?(wx.hideLoading(),wx.showToast({icon:"none",title:e.error_msg})):(wx.hideLoading(),t.pushToMessagePool("patient",t.data.formData.inputValue,"text"),t.pushToMessagePool("doctor",e.error_msg,"text"),t.setData({"formData.inputValue":""}),setTimeout(t.scrollToBottom,300))}))):wx.showToast({icon:"none",title:"病情描述不可少于".concat(this.data.showCount,"个字")})},handleSingleImageUpload:function(e){this.data.shouldListenImgUpdate&&(this.pushToMessagePool("patient",e.detail.imageObj.uniquePath,"image"),this.data.formData.imgUrlList.push(e.detail.imageObj))},handleSkipToArchive:function(){var e=this;this.track("AppClick",{click_position:"跳过发送病情描述",page_readable_name:"病情描述"}),this.saveDraft(),this.checkBlackList().then((function(){e.pushToMessagePool("doctor",e.data.messageStream.select_ehr,"text"),e.changeSectionIndex(2),e.changeTabIndex(2)})).catch((function(){e.pushToMessagePool("doctor",e.data.blackListMessage,"text"),e.setData({isInBlackList:!0})}))},changeTabIndex:function(e){this.setData({headerTabIndex:e})},handleSelectArchive:function(e){var t=e.detail.archive;this.data.formData.archive=t,this.setData({selectedArchive:t,headerTabIndex:this.data.urlData.problem_id?0:1}),this.changeTabIndex(3),1===this.data.pageType?(this.pushToMessagePool("patient","(".concat(t.sex,", ").concat(t.age,")"),"text"),this.getRecommendDoctorInfo()):2===this.data.pageType?this.saveContentToProblemId():3===this.data.pageType?this.emergencyProcess():4===this.data.pageType&&(this.pushToMessagePool("patient","(".concat(t.sex,", ").concat(t.age,")"),"text"),this.getRecommendDoctorInfo(void 0,!1),this.setData({shouldServiceListShow:!1,shouldBottomButtonSectionShow:!1,shouldFindDocFastButtonShow:!0}),this.changeSectionIndex(4))},generateContentStr:function(){var e=this.data.formData.imgUrlList,t=this.data.formData.archive,o=[];e.forEach((function(e){o.push({type:"image",file:e.url,tag:""})})),o.push({type:"text",text:this.data.formData.inputValue}),o.push(a({type:"patient_meta"},t)),this.data.formData.contentStr=JSON.stringify(o)},getRecommendDoctorInfo:function(e){var t=this,o=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._loading();var i=this.data.formData.imgUrlList,n=this.data.formData.archive,c=[];i.forEach((function(e){c.push({type:"image",file:e.url,tag:""})})),c.push({type:"text",text:this.data.formData.inputValue}),c.push(a({type:"patient_meta"},n)),this.data.formData.contentStr=JSON.stringify(c);var r={content_str:JSON.stringify(c),doctor_number:4===this.data.pageType?20:5,version:"10.3.4"};e&&(r.clinic_no=e),(0,s.default)({url:h,data:r,method:"POST",success:function(e){0===e.data.error_code&&(e.data.data.recommend_doctor.length&&e.data.data.recommend_doctor.forEach((function(e,a){e.default_select&&t.setData({selectedRecommendDoctors:[e],selectedRecommendDoctorIndexs:[a]})})),e.data.data.recommend_doctor.forEach((function(e){e.is_selected=e.default_select})),t.setData({recommendInfo:e.data.data,selectedClinicObj:{clinic_no:e.data.data.triage_second_clinic_no||e.data.data.triage_first_clinic_no}}),4===t.data.pageType?(wx.hideLoading(),t.calculateRecommendDoctorsSectionHeight()):o&&(t.getServicesList(),t.calculateDisplayPrice()))},fail:function(){wx.showToast({icon:"none",title:"无法连接到服务器，请退出重试"})}})},handleConfirmClinic:function(e){this.track("AppClick",{click_position:"重选科室",page_readable_name:"病情描述"}),this.setData({selectedClinicObj:e.detail.clinicObj,hasReselectClinic:!0}),this.getRecommendDoctorInfo(this.data.selectedClinicObj.clinic_no,!1),this.getServicesList(this.data.selectedClinicObj.clinic_no),this.data.selectedRecommendDoctors=[],this.data.selectedBasicService={}},toggleComponent:function(e){this.setData({shouldClinicSelectorShow:e.detail.shouldShow})},getServicesList:function(e){var t=this;wx.request({url:u,header:{Cookie:c.globalData.sessionid,"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{clinic_no:e||this.data.recommendInfo.triage_second_clinic_no||this.data.recommendInfo.triage_first_clinic_no,ehr_id:this.data.formData.archive.ehr_id,partner:"chunyu_wap_mini",ask_text:this.data.formData.inputValue||"测试用感冒了感冒了感冒了感冒了",version:"10.3.4"},success:function(e){wx.hideLoading(),0===e.data.error_code&&(t.getCouponInfo(),t.setData({serviceList:e.data.data,selectedBasicService:e.data.data.service_list.filter((function(e){return e.default_select}))[0]||{}}),e.data.data.service_list.forEach((function(e,a){e.default_select&&t.setData({selectedBasicServiceIndex:a})})),t.changeSectionIndex(4),t.calculateDisplayPrice(),t.calculateDoctorsSectionHeight())},fail:function(){wx.hideLoading(),wx.showToast({icon:"none",title:"无法连接到服务器，请退出重试"})}})},handleSelectBasicService:function(e){var t=Number(e.detail.serviceIndex);this.data.selectedBasicServiceIndex=t,this.data.selectedBasicService=999===t?[]:this.data.serviceList.service_list[t],this.calculateDisplayPrice()},handleSelectDoctors:function(e){console.log(e.detail.listIndex);var a=e.detail.listIndex,o="recommendInfo.recommend_doctor[".concat(a,"].is_selected");this.setData(t({},o,!this.data.recommendInfo.recommend_doctor[a].is_selected));var i=this.data.recommendInfo.recommend_doctor.filter((function(e){return e.is_selected})),n=[];this.data.recommendInfo.recommend_doctor.forEach((function(e,t){e.is_selected&&n.push(t)})),this.data.selectedRecommendDoctorIndexs=n,this.data.selectedRecommendDoctors=i,this.calculateDisplayPrice()},handleClickToPay:function(){var e,t,a,o=this,i=[];999!==this.data.selectedBasicServiceIndex&&i.push("众包-".concat(this.data.selectedBasicServiceIndex+1));var n="";this.data.selectedRecommendDoctorIndexs.length&&(n="一提多问-",this.data.selectedRecommendDoctorIndexs.forEach((function(e){n+=e+1}))),i.push(n),i.push((null===(e=this.data.recommendInfo)||void 0===e||null===(t=e.recommend_doctor)||void 0===t||null===(a=t[0])||void 0===a?void 0:a.relation_tag)||"无标签"),this.track("AppClick",{click_position:"去问诊",page_readable_name:"病情描述",click_position_value:i.join(",")}),this.beforeGoToPay().then((function(){o.generatePayParams()}))},generatePayParams:function(){var e=this,t=Object.keys(this.data.selectedBasicService).length?1:0,a=this.data.selectedRecommendDoctors.length,o=function(){var t={type:e.data.selectedBasicService.type||"graph",info:{clinic_no:e.data.selectedClinicObj.clinic_no,content_str:e.data.formData.contentStr,partner:"chunyu_wap_mini"}};return 4===e.data.pageType?t.info.cy_page_from="one_click_doctor":t.info.cy_page_from="select_doctor","graph"!==t.type&&e.data.hasReselectClinic&&(t.info.has_change_clinic=!0),"graph"===t.type&&(t.info.doctor_id=e.data.selectedBasicService.doctor_id),"qa_upgrade"===t.type?t.info.upgrade_type=e.data.selectedBasicService.upgrade_type:"emergency_graph"===t.type?t.info.emergency_graph_from_type="quick_ask":"fast_phone"===t.type&&(t.info.phone=e.data.selectedBasicService.phone),t};if(a+t>1){var i={type:"package",info:{sub_list:[]},recommend_id:this.data.recommendInfo.recommend_id};t&&i.info.sub_list.push(o()),this.data.selectedRecommendDoctors.forEach((function(t){var a={type:"graph",info:{doctor_id:t.id,content_str:e.data.formData.contentStr,show_pay:t.price_fen/100,partner:"chunyu_wap_mini"}};i.info.sub_list.push(a)})),4===this.data.pageType?i.info.cy_page_from="one_click_doctor":i.info.cy_page_from="select_doctor",c.globalData.order_data=i,console.log(i),wx.navigateTo({url:"/pages/payment/index?new_fast_qa=1"})}else{var n=o();n.recommend_id=this.data.recommendInfo.recommend_id,a&&(n.info.show_pay=this.data.selectedRecommendDoctors[0].price_fen/100,n.info.doctor_id=this.data.selectedRecommendDoctors[0].id),c.globalData.order_data=n,console.log(n),wx.navigateTo({url:"/pages/payment/index?new_fast_qa=1"})}},calculateDisplayPrice:function(){var e=0;Object.keys(this.data.selectedBasicService).length&&(e=this.data.selectedBasicService.price);var t=0;this.data.selectedRecommendDoctors.forEach((function(e){t+=e.price_fen}));var a=e+t;a>0?this.setData({priceForButtonShow:a/100}):this.setData({priceForButtonShow:0})},beforeGoToPay:function(){var e=this;return new Promise((function(t,a){return Object.keys(e.data.selectedBasicService).length||e.data.selectedRecommendDoctors.length?"fast_phone"===e.data.selectedBasicService.type?(e.setData({shouldPhoneInputShow:!0,userPhone:e.data.selectedBasicService.phone}),a()):"video_inquiry_saas"===e.data.selectedBasicService.type&&e.data.selectedBasicService.need_real_name_verify?(wx.navigateTo({url:"/pages/health_record_certification_edit/index?ehrId=".concat(e.data.selectedArchive.ehr_id,"&pageType=edit&isNeedRealName=true&fromVideo=1")}),a()):t():(wx.showToast({icon:"none",title:"请选择至少一项服务"}),a())}))},saveContentToProblemId:function(){var e=this;this.generateContentStr();var t={from_wx_mini:1,content:this.data.formData.contentStr,problem_id:this.data.urlData.problem_id,partner:"chunyu_wap_mini"};wx.request({url:m,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",Cookie:c.globalData.sessionid},data:t,success:function(t){console.log(t),0===t.data.error&&wx.redirectTo({url:"/pages/qa_im/index?problem_id=".concat(e.data.urlData.problem_id)})}})},emergencyProcess:function(){this.generateContentStr();var e={type:"emergency_graph",info:{clinic_no:this.data.urlData.emergency_clinic_no,emergency_graph_from_type:"quick_ask",partner:"chunyu_wap_mini",content_str:this.data.formData.contentStr}};c.globalData.order_data=e,wx.navigateTo({url:"/pages/payment/index?new_fast_qa=1"})},scrollToBottom:function(){this.setData({scrollAnchor:"bottom-anchor"})},scrollToNode:function(e){this.setData({scrollAnchor:e})},subscribeMessage:function(e){return new Promise((function(t,a){wx.requestSubscribeMessage({tmplIds:e,fail:function(e){a(e),console.error(e)},success:function(e){t(e),console.log(e)}})}))},handleUnauthorize:function(e){this.setData({shouldListenImgUpdate:!0,isUserRefuseToAuthorize:!0,operatingSectionIndex:5})},handleConfirmPhone:function(e){this.setData({"selectedBasicService.phone":e.detail.phone}),this.generatePayParams()},handleHidePhoneInput:function(){this.setData({shouldPhoneInputShow:!1})},relogin:function(){this.changeSectionIndex(2),this.pushToMessagePool("doctor",this.data.messageStream.select_ehr,"text"),this.SCROLL_DEBOUNCE()},previewImage:function(e){var t=e.currentTarget.dataset.url;if("image"===e.currentTarget.dataset.contenttype){var a=[];this.data.formData.imgUrlList.forEach((function(e){a.push(e.uniquePath)})),wx.previewImage({urls:a,current:t})}},handleFindDoctorFastPay:function(e){var t=e.detail.selectedDoctor;this.data.selectedRecommendDoctors=[t],this.generatePayParams()},setPlaceholderHeight:function(e){this.setData({scorllPlaceholderHeight:Number(e)})},calculateDoctorsSectionHeight:function(){var e=this,t=[(0,i.getElementRec)("#scroll-view"),(0,i.getElementRec)("#recommend-anchor")];this.data.recommendInfo.recommend_doctor.length&&t.push((0,i.getElementRec)("#more-recommend-anchor")),Promise.all(t).then((function(t){console.log(t);var a=t[0].height||0,o=t[1].height||0,i=t[2]&&t[2].height||0;console.log(a,o,i);var n=a-o-i-10;console.log(n),n?e.setPlaceholderHeight(n):e.setPlaceholderHeight(40),setTimeout((function(){e.scrollToNode("recommend-anchor")}),300)}))},calculateRecommendDoctorsSectionHeight:function(){var e=this;this.data.recommendInfo.recommend_doctor.length&&Promise.all([(0,i.getElementRec)("#scroll-view"),(0,i.getElementRec)("#more-recommend-anchor")]).then((function(t){console.log(t);var a=t[0].height||0,o=t[1].height||0;console.log(a,o);var i=a-o-20;i&&e.setPlaceholderHeight(i),setTimeout((function(){e.scrollToNode("more-recommend-anchor")}),300)}))},handleGoToFindDoc:function(){this.track("AppClick",{click_position:"查看更多同科室医生",page_readable_name:"病情描述"})},track:function(e,t){var o=a(a({},t),{},{app:"weixin_mini",from_type:this.data.fromTypeForTrack});console.log(o),c.sensors.track(e,o)},handleArchiveRenderReady:function(){this.SCROLL_DEBOUNCE()},handleUpdateImageList:function(e){var t=this;this.data.shouldListenImgUpdate=!0,this.data.formData.imgUrlList=e.detail.imgUrlList,this.data.formData.imgUrlList.forEach((function(e){t.pushToMessagePool("patient",e.uniquePath,"image")})),0===this.data.formData.imgUrlList.length&&this.pushToMessagePool("patient","暂无图片","text"),this.SCROLL_DEBOUNCE()},handleInputFocus:function(e){console.log("textarea focused"),this.setData({hasInputFocused:!0});var t="";e&&(t=e.detail.height,console.log("当前存储的键盘高度",this.data.keyboardHeight,"获取的键盘高度",t),this.data.keyboardHeight<t&&(this.data.keyboardHeight=t)),this.data.keyboardHeight&&this.setData({textAreaBottom:this.data.keyboardHeight},this.scrollToBottom)},handleInputBlur:function(){this.setData({textAreaBottom:0,hasInputFocused:!1})},_loading:function(){wx.showLoading({title:"加载中",mask:!0}),setTimeout(wx.hideLoading,1500)},getCouponInfo:function(){var e=this;(0,s.default)({url:f,method:"GET",success:function(t){if(console.log(t),0===t.data.error_code){var a=t.data.data;e.setData({couponId:a.coupon.coupon_id}),a.coupon&&a.coupon.had_coupon&&!a.coupon.is_expired&&e.showAlertBeforeLeave(),a.is_paid_problem||a.coupon.had_coupon||!a.coupon.coupon_id||setTimeout(e.showCouponDialog,1500)}else e.setData({hasInputFocused:!0})},fail:function(e){console.log(e)}})},showCouponDialog:function(){c.sensors.track("PageView",{app:"weixin_mini",page_readable_name:"新用户弹窗"}),this.setData({shouldCouponDialogShow:!0})},onGetCoupon:function(){this.setData({shouldCouponDialogShow:!1}),setTimeout(this.refreshServiceList,500),this.data.shouldShowAlertBeforeLeave||this.showAlertBeforeLeave()},showAlertBeforeLeave:function(){c.sensors.track("PageView",{app:"weixin_mini",page_readable_name:"新用户阻拦弹窗"}),this.data.shouldShowAlertBeforeLeave=!0,wx.enableAlertBeforeUnload({message:"您的限时3元三甲咨询红包即将过期，是否要继续退出"})},refreshServiceList:function(){var e=this;wx.request({url:u,header:{Cookie:c.globalData.sessionid,"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{clinic_no:this.data.recommendInfo.triage_second_clinic_no||this.data.recommendInfo.triage_first_clinic_no,ehr_id:this.data.formData.archive.ehr_id,partner:"chunyu_wap_mini",ask_text:this.data.formData.inputValue,version:"10.1.0"},success:function(t){wx.hideLoading(),0===t.data.error_code&&(e.setData({serviceList:t.data.data,selectedBasicService:t.data.data.service_list.filter((function(e){return e.default_select}))[0]||{}}),t.data.data.service_list.forEach((function(t,a){t.default_select&&e.setData({selectedBasicServiceIndex:a})})),e.calculateDisplayPrice())},fail:function(){wx.hideLoading(),wx.showToast({icon:"none",title:"无法连接到服务器，请退出重试"})}})},onSelectHistory:function(e){var t=this.data.messageStream.quick_input[e.detail.historyIndex];this.setData({"formData.inputValue":t.content})},refusePhoneNumber:function(e){console.log(e.detail);var t=e.detail.hasSelectedPic;this.data.isPhoneNumberRequested?(console.log("拒绝了授权 是强求"),this.changeSectionIndex(6)):t?(console.log("已选图片 拒绝了授权 不是强求"),this.handleToArchive(e)):(console.log("未选图片 拒绝了授权 不是强求"),this.handleSkipToArchive())},getPhoneNUmber:function(){this.handleToArchive()},getUserDetail:function(){var e=this;(0,s.default)({url:D,success:function(t){var a;e.setData({hasBindPhoneNumber:!(null===(a=t.data)||void 0===a||!a.use_cellphone)})}})},checkCanSkipPhone:function(){var e=this;(0,s.default)({url:g,success:function(t){var a,o;(console.log(t),0===t.data.error_code)&&e.setData({isPhoneNumberRequested:!(null!==(a=t.data)&&void 0!==a&&null!==(o=a.data)&&void 0!==o&&o.can_skip_phone)})}})}});
},{isPage:true,isComponent:true,currentFile:'pages/inquery/inquery.js'});require("pages/inquery/inquery.js");