$gwx_XC_33=function(_,_v,_n,_p,_s,_wp,_wl,$gwn,$gwl,$gwh,wh,$gstack,$gwrt,gra,grb,TestTest,wfor,_ca,_da,_r,_rz,_o,_oz,_1,_1z,_2,_2z,_m,_mz,nv_getDate,nv_getRegExp,nv_console,nv_parseInt,nv_parseFloat,nv_isNaN,nv_isFinite,nv_decodeURI,nv_decodeURIComponent,nv_encodeURI,nv_encodeURIComponent,$gdc,nv_JSON,_af,_gv,_ai,_grp,_gd,_gapi,$ixc,_ic,_w,_ev,_tsd){return function(path,global){
if(typeof global==='undefined'){if (typeof __GWX_GLOBAL__==='undefined')global={};else global=__GWX_GLOBAL__;}if(typeof __WXML_GLOBAL__ === 'undefined') {__WXML_GLOBAL__={};
}__WXML_GLOBAL__.modules = __WXML_GLOBAL__.modules || {};
var e_={}
if(typeof(global.entrys)==='undefined')global.entrys={};e_=global.entrys;
var d_={}
if(typeof(global.defines)==='undefined')global.defines={};d_=global.defines;
var f_={}
if(typeof(global.modules)==='undefined')global.modules={};f_=global.modules || {};
var p_={}
__WXML_GLOBAL__.ops_cached = __WXML_GLOBAL__.ops_cached || {}
__WXML_GLOBAL__.ops_set = __WXML_GLOBAL__.ops_set || {};
__WXML_GLOBAL__.ops_init = __WXML_GLOBAL__.ops_init || {};
var z=__WXML_GLOBAL__.ops_set.$gwx_XC_33 || [];
function gz$gwx_XC_33_1(){
if( __WXML_GLOBAL__.ops_cached.$gwx_XC_33_1)return __WXML_GLOBAL__.ops_cached.$gwx_XC_33_1
__WXML_GLOBAL__.ops_cached.$gwx_XC_33_1=[];
(function(z){var a=11;function Z(ops){z.push(ops)}
Z([a,[3,'machine flex-col-hc '],[[7],[3,'theme']]])
Z([[6],[[7],[3,'themeConf']],[3,'machineTopCoin']])
Z([[6],[[7],[3,'machine']],[3,'drawing']])
Z([3,'clickPrizesBtn'])
Z([3,'btn-myprize'])
Z([[7],[3,'showBtnBadge']])
Z([3,'showRule'])
Z([3,'rule'])
Z([3,'clickModalBtn'])
Z([3,'clickModalTip'])
Z([[6],[[7],[3,'modal']],[3,'data']])
Z([[6],[[7],[3,'modal']],[3,'visible']])
Z(z[0][2])
Z([[7],[3,'rule']])
Z([[7],[3,'ruleVisible']])
})(__WXML_GLOBAL__.ops_cached.$gwx_XC_33_1);return __WXML_GLOBAL__.ops_cached.$gwx_XC_33_1
}
__WXML_GLOBAL__.ops_set.$gwx_XC_33=z;
__WXML_GLOBAL__.ops_init.$gwx_XC_33=true;
var x=['./miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.wxml'];d_[x[0]]={}
var m0=function(e,s,r,gg){
var z=gz$gwx_XC_33_1()
var t7I=_n('view')
_rz(z,t7I,'class',0,e,s,gg)
var e8I=_v()
_(t7I,e8I)
if(_oz(z,1,e,s,gg)){e8I.wxVkey=1
}
var b9I=_v()
_(t7I,b9I)
if(_oz(z,2,e,s,gg)){b9I.wxVkey=1
}
var o0I=_mz(z,'view',['bindtap',3,'class',1],[],e,s,gg)
var xAJ=_v()
_(o0I,xAJ)
if(_oz(z,5,e,s,gg)){xAJ.wxVkey=1
}
xAJ.wxXCkey=1
_(t7I,o0I)
var oBJ=_mz(z,'slot',['bindtap',6,'name',1],[],e,s,gg)
_(t7I,oBJ)
e8I.wxXCkey=1
b9I.wxXCkey=1
_(r,t7I)
var fCJ=_mz(z,'luckydraw-modal',['bind:click-btn',8,'bind:click-tip',1,'data',2,'show',3,'theme',4],[],e,s,gg)
_(r,fCJ)
var cDJ=_mz(z,'rule-box',['rule',13,'show',1],[],e,s,gg)
_(r,cDJ)
return r
}
e_[x[0]]={f:m0,j:[],i:[],ti:[],ic:[]}
if(path&&e_[path]){
return function(env,dd,global){$gwxc=0;var root={"tag":"wx-page"};root.children=[]
;g="$gwx_XC_33";var main=e_[path].f
if (typeof global==="undefined")global={};global.f=$gdc(f_[path],"",1);
try{
main(env,{},root,global);
_tsd(root)
}catch(err){
console.log(err)
}
;g="";
return root;
}
}
}
}(__g.a,__g.b,__g.c,__g.d,__g.e,__g.f,__g.g,__g.h,__g.i,__g.j,__g.k,__g.l,__g.m,__g.n,__g.o,__g.p,__g.q,__g.r,__g.s,__g.t,__g.u,__g.v,__g.w,__g.x,__g.y,__g.z,__g.A,__g.B,__g.C,__g.D,__g.E,__g.F,__g.G,__g.H,__g.I,__g.J,__g.K,__g.L,__g.M,__g.N,__g.O,__g.P,__g.Q,__g.R,__g.S,__g.T,__g.U,__g.V,__g.W,__g.X,__g.Y,__g.Z,__g.aa);if(__vd_version_info__.delayedGwx||false)$gwx_XC_33();	if (__vd_version_info__.delayedGwx) __wxAppCode__['miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.wxml'] = [$gwx_XC_33, './miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.wxml'];else __wxAppCode__['miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.wxml'] = $gwx_XC_33( './miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.wxml' );
	;__wxRoute = "miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine";__wxRouteBegin = true;__wxAppCurrentFile__="miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.js";define("miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.js",function(require,module,exports,window,document,frames,self,location,navigator,localStorage,history,Caches,screen,alert,confirm,prompt,XMLHttpRequest,WebSocket,Reporter,webkit,WeixinJSCore){
"use strict";var e,t=require("../../../../@babel/runtime/helpers/objectSpread2"),i=require("../../../../@babel/runtime/helpers/slicedToArray"),n=(e=require("./utils"))&&e.__esModule?e:{default:e};var r="https://static.img.tai.qq.com/mp/components/luckydraw";Component({options:{multipleSlots:!0},properties:{promotionCode:String,pageFrom:String,customizeDrawResultUI:Boolean,theme:{type:String,value:"blue",observer:function(e,t){e!==t&&this.updateTheme(e)}}},data:{loaded:!1,prizes:[],remainTimes:0,status:0,rule:"",ruleVisible:!1,themeConf:{machineBgImg:"".concat(r,"/theme-blue-bg-machine.png"),machineTopCoin:"".concat(r,"/theme-blue-machine-top-coin.png"),drawingMask:"".concat(r,"/theme-blue-drawing-mask.png")},machine:{drawing:!1,currentIndex:0,speeds:[800,500,300,200,100],seqs:[0,1,2,5,8,7,6,3]},hasPhone:!1},userPhone:"",speeds:[],seqs:[],flowEndJumps:null,lightIndex:0,drawAnimation:{promise:null,resolver:null,rejecter:null},justDrawed:null,lifetimes:{created:function(){this.userPhone="",this.lightIndex=0,this.drawAnimation={promise:null,resolver:null,rejecter:null}},attached:function(){this.updateTheme(this.data.theme),this.loadData()}},methods:{updateTheme:function(e){e},loadData:function(){var e=this;this.triggerEvent("data-load-start",{});var t=n.default.loadPromotionInfo(this.data.promotionCode),s=n.default.loadPromotionConf(this.data.promotionCode),a=n.default.fetchUserPhone();Promise.all([t,s,a]).then((function(t){var n=i(t,3),s=n[0],a=n[1],o=n[2],d=!!o,u=s||{},c=u.basic,l=u.user,h=u.prizes,m=u.rule;l.hasPhone=d;var p=(a||{}).publicSrc;e.triggerEvent("data-load-success",{basic:c,prizes:h,rule:m,user:l,conf:{publicSrc:p}});var f=s.basic,v=f.desc,w=f.endTime,g=s.user,T=g.totalDrawTimes-g.drawedTimes,I=w-Date.now(),b=h.map((function(e){return{id:e.id,name:e.name,img:e.pic.pool,gotImg:e.pic.got,kind:e.type}})),R={img:"".concat(r,"/theme-blue-draw-btn.png"),disable:!I||!T};b.splice(4,0,R),e.setData({loaded:!0,remainTimes:T,status:I,rule:v,prizes:b,hasPhone:d}),e.userPhone=o})).catch((function(t){return e.triggerEvent("data-load-fail",{error:t})}))},clickDrawBtn:function(e){var t=this;if("4"===e.currentTarget.id){var i=this.data,r=i.hasPhone,s=i.prizes,a=i.status,o=i.remainTimes;if(s[4].disable){var d="";return d=a<=0?"ACTIVITY_FINISHED":o<=0?"NO_REMAIN_DRAW_TIMES":"UNKNOWN",void this.triggerEvent("draw-fail",{reason:d})}if(r)this.draw();else{var u=e.detail,c=u.encryptedData,l=u.iv;n.default.registerPhone(c,l).then((function(e){t.userPhone=e,t.setData({hasPhone:!0}),t.triggerEvent("user-phone-change",{phone:e}),t.draw()})).catch((function(e){t.triggerEvent("draw-fail",{reason:"REGISTER_PHONE_ERROR",error:e})}))}}},draw:function(){var e=this;if(!this.drawProm){this.setData({"machine.drawing":!0});var r=this.flowStart(),s=Date.now(),a=n.default.draw(this.data.promotionCode).then((function(i){var r=i.id,s=i.prize,a=i.coupons;return 1!==s.type?{success:!0,data:i}:n.default.receiveCoupons(e.data.promotionCode,r,a,e.userPhone).then((function(e){var i=a.map((function(i,n){var r=(null==e?void 0:e[n])||{},s=r.errCode,a=r.resData;return t(t({},i),0===s&&a||{})}));return{success:!0,data:{prize:s,coupons:i,receiveResults:e,receiveSuccess:!0}}})).catch((function(e){return{success:!0,data:{drawId:r,prize:s,coupons:a,receiveSuccess:!1,receiveError:e}}}))})).catch((function(e){return{success:!1,error:e}})).then((function(t){return e.flowEnd(t,s,3e3),t}));return this.drawProm=Promise.all([a,r]).then((function(t){var n=i(t,1)[0],r=n.success,s=n.data,a=n.error;if(r){e.changeRemainTimes(-1);var o=s.drawId,d=s.prize,u=s.coupons,c=s.receiveSuccess,l=s.receiveResults,h=s.receiveError;e.triggerEvent("draw-success",{drawId:o,prize:d,coupons:u,receiveSuccess:c,receiveResults:l,receiveError:h})}else{var m="UNKNOWN";1093===(null==a?void 0:a.errCode)&&(m="NO_REMAIN_DRAW_TIMES"),e.triggerEvent("draw-fail",{reason:m,error:a})}var p=i(e.data.machine.speeds,1)[0];setTimeout((function(){!e.data.customizeDrawResultUI&&e.showDrawResult(n),e.drawProm=null,e.setData({"machine.drawing":!1})}),p)})),this.drawProm}},flowStart:function(){var e=this;if(this.drawAnimation.promise)return this.drawAnimation.promise;var t=this.data.machine,i=t.seqs,n=t.speeds;return this.lightIndex=this.lightIndex%i.length,this.speeds=n.concat().reverse().reverse(),this.seqs=i.concat(),this.flowEndJumps=null,this.flowNext(),this.drawAnimation.promise=new Promise((function(t,i){e.drawAnimation.resolver=t,e.drawAnimation.rejecter=i})).then((function(t){return e.drawAnimation.promise=null,t})).catch((function(t){return e.drawAnimation.promise=null,Promise.reject(t)})),this.drawAnimation.promise},flowNext:function(){clearTimeout(this.timer);var e=this.lightIndex%this.seqs.length;if(this.lightIndex+=1,this.setData({"machine.currentIndex":this.seqs[e]}),null===this.flowEndJumps){var t=this.data.machine.speeds.slice(-1),n=i(t,1)[0];this.speeds.length&&(n=this.speeds.shift()),this.timer=setTimeout(this.flowNext.bind(this),n)}else if(this.flowEndJumps.length)this.timer=setTimeout(this.flowNext.bind(this),this.flowEndJumps.shift());else{var r=this.drawAnimation,s=r.promise,a=r.resolver;s&&a&&a()}},flowEnd:function(e,t,i){var n=this,r=e.success,s=e.data,a=-1;r&&0!==s.id&&(a=this.data.prizes.findIndex((function(e){return e.id===s.prize.id}))),-1===a&&(a=this.data.prizes.findIndex((function(e){return 0===e.kind})));var o=r?i-(Date.now()-t):0;setTimeout((function(){return n.setFlowStopPoint(a)}),o)},setFlowStopPoint:function(e){var t=this.data.machine,i=t.seqs,n=t.speeds,r=i.length,s=r-(this.lightIndex-1)%r+i.findIndex((function(t){return t===e}));s<=n.length&&(s+=r);for(var a=n.concat(),o=0;o<s-n.length-1;o++)a.push(n.slice(-1)[0]);this.flowEndJumps=a.reverse()},showDrawResult:function(e){var t=e.success,i=e.data,n=e.error;if(t){var r=i.prize,s=i.coupons,a=i.receiveResults;0===r.id?this.showNoPrizeResult():1===r.type?this.showReceiveCouponResult(r,s,a):this.showReceiveGoodsResult(r)}else{if(1093===(null==n?void 0:n.errCode))return;this.showUIModal({id:"close",imgUrl:"net",title:"网络开小差了",viceContent:"请点击页面右上角省略号\n重新进入页面！",btnText:"我知道了"})}},showNoPrizeResult:function(){this.showUIModal({id:"close",title:"没有抽中",btnText:"我知道了",imgUrl:"notwin"})},showReceiveCouponResult:function(e,t,i){var n=0,r=0;Array.isArray(i)&&i.forEach((function(e){0===e.errCode?n+=1:r+=1})),0!==n&&0===r?(this.justDrawed={prize:e,coupons:t},this.showUIModal({id:"useCoupon",title:"恭喜获得".concat(e.name),btnText:"立即使用",imgUrl:e.pic.got})):this.showUIModal({id:"close",title:"恭喜获得".concat(e.name),viceContent:"当前".concat(0===n?"":"部分","领取失败，请在我的奖品重试，\n或联系在线客服"),btnText:"我知道了",btnType:"",imgUrl:"err"})},clickModalBtn:function(e){if("useCoupon"===e.detail.id){var t,i,r=null===(t=this.justDrawed)||void 0===t||null===(i=t.coupons)||void 0===i?void 0:i[0];r&&n.default.useCoupon(r)}},showReceiveGoodsResult:function(e){this.showUIModal({id:"close",title:e.name,btnText:"我知道了",btnType:"",imgUrl:e.pic.got})},showUIModal:function(e){this.setData({modal:{data:e,visible:!0}})},clickPrizesBtn:function(){this.triggerEvent("tap-prizes-btn",{})},addDrawTimes:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.adding?Promise.reject("One add times request is already exists, cannot add several times at same time"):(this.adding=!0,n.default.addDrawTimes(this.data.promotionCode,t).then((function(t){return e.changeRemainTimes(1),e.adding=!1,t})).catch((function(t){return e.adding=!1,Promise.reject(t)})))},changeRemainTimes:function(e){var t=this.data.remainTimes+e;this.setData({remainTimes:t,"prizes[4].disable":!t})},showRule:function(){this.setData({ruleVisible:!0})}}});
},{isPage:false,isComponent:true,currentFile:'miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.js'});require("miniprogram_npm/@tmsfe/tms-ui/luckydraw/machine.js");