# Uncovering API-Scope Misalignment in the App-in-AppEcosystem

## Table of Contents
- Abstract

- API-Scope Misalignment in the App-in-App Ecosystem

  - Backgrund

  - Motivation

  - Approach

    - API-ScopeChecker
    - APP-ScopeChecker

  - Getting Started

    - API-ScopeChecker
    - APP-ScopeChecker
 
  - Data
  
  - Result
 
  - Attack  Video Demos
 
  - Vendor Response

## PCDA

Here is the introduction of pcda

## Approach

### Problem API Detaction

PCDA_API

### Affected APP Detaction

The PCDA APP Detection is a bundle of scripts that can be used to detect
the presence of the PCDA (Privilege Config Defect API) in a given WeChat app.

## Getting Started

### Environment


Operating System: Windows 10/11 and macOS 13 is tested, but it should work on other versions as well.

Python Version: >= 3.6

Node.js Version: >= 12.22.12


### How to Use

#### Cloning the GitHub Project

Start by cloning the PCDA_APP from GitHub using the following command:

git clone https://github.com/an-luckydog/ScopeChecker

#### Installing the Required Packages

Navigate to the PCDA_APP directory and install the required packages using the following command:

```bash
pip install -r requirements.txt
```

We recommend using a virtual environment to install the required packages.

#### Preparing the Configuration File

Add the following configuration to the `config.json` file:

```json
{
  "input_applets_dir": "",
  "output_results_dir": "",
  "type": "wx",
  "problem_apis": [
    "chooseImage",
    "chooseVideo",
    "chooseMedia",
    "getClipboardData"
  ],
  "append": "true"
}
```
Where `input_applets_dir` is the directory where the WeChat applets are located.

It is usually located in the following path on Windows:
```
C:\\Users\\{UserName}\\Documents\\WeChat Files\\Applet
```
and
```
/Users/{UserName}/Library/Containers/com.tencent.xinWeChat/Data/.wxapplet/packages
```
on macOS.

`output_results_dir` is the directory where the results will be saved.
`append` is a boolean value that indicates whether the results should be appended to the file or not.

The `type` field is used to specify the type of the applets. It is mapped to the following values:


| Super app | Applet type |
| --------- | ----------- |
| Wechat    | wx          |
| Baidu     | swan        |
| QQ        | qq          |


If `append` is set to `false`, the output `applet_info.csv` file will be overwritten.


#### Testing the PCDA Detection Script

You should have the `config.json` file ready before running the PCDA detection script and having the WeChat or other applets as it is in the `input_applets_dir` directory.

To test the PCDA detection script, run the following command:

```bash
python3 main.py
```

It will generate the `applet_info.csv` file in the `output_results_dir/report` directory.

Results for each applet will also be saved in the `output_results_dir/report` directory.

If errors occur, please check the files generated in the `output_results_dir` directory.

It should also include the `decrypted_code` files generated by the `pc_wxapkg_decrypt` tool.


## Results

The results of the PCDA detection script are saved in the `applet_info.csv` file in the `output_results_dir/report` directory.

You can click [Here](./output_results_dir/report/applet_info.csv) to view the results we obtained.
## References

- [pc_wxapkg_decrypt](https://github.com/BlackTrace/pc_wxapkg_decrypt)
- [wxappUnpacker](https://github.com/system-cpu/wxappUnpacker)
- [app_id_info](https://kainy.cn/api/weapp/info/)
